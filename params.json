{"name":"Couchdb-dump","tagline":"Tools to dump, modify, and load documents in CouchDB from the command line. (Same basic concept as mysqldump, but much more and for CouchDB)","body":"couchdb-dump\r\n========\r\n\r\nA set of three command line tools that perform the following functions. \r\n* `cdbdump` outputs all documents (including any attachments) in a [CouchDB](http://couchdb.apache.org) database\r\n* `cdbmorph` lets you provide a function that can modify the documents in that output\r\n* `cdbload` takes that output as input and loads it back into a CouchDB database.\r\n\r\nReading and writing the data is done via stdin and stdout, respectively. The output of `cdbdump` is a JSON document containing a \"docs\" array element which contains every document in the database. The `cdbmorph` command takes the output of `cdbdump` and allows you to modify the documents in it by passing each of them through a function that you supply. The `cdbload` command takes an input which is exactly the same as the output of `cdbdump` or `cdbmorph` and writes every document in it into the target database.\r\n\r\n## Installation\r\n\r\n`npm install -g couchdb-dump`\r\n\r\n## Usage Examples\r\n\r\nThe following will dump the contents of a CouchDB database called *myhugedatabase* running on port 5984 on localhost. The output is written to a file called *myhugedatabase.json*.\r\n\r\n`cdbdump -d myhugedatabase > myhugedatabase.json`\r\n\r\nIf you are doing this for archiving purposes you could do something cool like this to extract and gzip it in one step ...\r\n\r\n`cdbdump -d myhugedatabase | gzip > myhugedatabase.json.gz`\r\n\r\nBoth of the following command examples will load all the documents in the *myhugedatabase.json* file into a CouchDB database called *myhugeduplicate*.\r\n\r\n`cdbload -d myhugeduplicate < myhugedatabase.json`<br>\r\n **OR**<br>\r\n`cat myhugedatabase.json | cdbload -d myhugeduplicate`\r\n\r\nYou can even do this ...\r\n\r\n`cdbdump -d myhugedatabase | cdbload -d myhugeduplicate`\r\n\r\n... which streams all the docs from one CouchDB database into a second one. While this works well, you should probably take a look at using [CouchDB's awesome built-in replication features](http://guide.couchdb.org/draft/replication.html) instead.\r\n\r\nBut suppose you need to manipulate the documents in the `cdbdump` output before you load them into CouchDB with `cdbload`. You can do that with the included `cdbmorph` command.\r\n\r\nLets assume you need to add a new key and value to all documents which meet certain criteria, and you need to delete documents which meet some other criteria. So you write a function as follows and save it in a file called *morph.js*. For example:\r\n\r\n    module.exports = function(doc, cb){\r\n      if(doc.somekey && doc.somekey === 'somevalue'){\r\n        doc.anotherkey = 'anothervalue';\r\n      }\r\n      if(doc.someotherkey && doc.someotherkey === 'someothervalue'){\r\n        doc._deleted = true;\r\n      }\r\n      cb(null, doc);\r\n    }\r\n\r\nNow you can run the documents in the *myhugedatabase.json* file from the example above through this function and feed the output into a file or directly back into a CouchDB database as follows ...\r\n\r\n`cat myhugedatabase.json | cdbmorph -f ./morph.js | cdbload -d myhugemodified`\r\n\r\nYou can also pipe output directly from `cdbdump` to `cdbmorph` to `cdbload` like this ...\r\n\r\n`cdbdump -d myhugedatabase | cdbmorph -f ./morph.js | cdbload -d myhugemodified`\r\n\r\nYou can even put modified documents back into a CouchDB database by loading the stream of changed documents back into the source database, simulating the feel of in-place-updates, like this ...\r\n\r\n`cdbdump -k -d myhugedatabase | cdbmorph -f ./morph.js | cdbload -d myhugedatabase`\r\n\r\n*NOTE: This is not magic and it is not \"real\" in-place-updates so all the rules of CouchDB document updates with respect to* **_rev** *values, etc, still apply. Be mindful of this and other activity on the database if you do something like this. Also, be sure to apply the* **-k** *flag on the `cdbdump` command so that the documents in the output will include their* **_rev** *values.*\r\n\r\n\r\n## `cdbdump` Full Usage\r\n\r\nIf you execute the `cdbdump` command with no arguments or with --help, the following usage information will be printed on the console and the command will exit.\r\n\r\n`usage: cdbdump [-u username] [-p password] [-h host] [-P port] [-r protocol] [-s json-stringify-space] [-k dont-strip-revs] [-D design doc] [-v view] -d database`\r\n\r\nThe username and password, if supplied, will be used for authentication via [Basic Auth (RFC2617)](http://docs.couchdb.org/en/1.6.1/api/server/authn.html#api-auth-basic). Currently this is the only supported authentication method.\r\n\r\nIf you want to constrain the documents exported to only those that belong to a [CouchDB View](http://docs.couchdb.org/en/1.6.1/couchapp/ddocs.html), you can pass the **-D** and **-v** options to specify the design document and view function name respectively. This won't work with views that *reduce* or do other fancy things.\r\n\r\nThe **-s** parameter for `cdbdump` is used as the third parameter to JSON.stringify() for the amount of white space to use if you want the output to be pretty-printed.\r\n\r\n##### CouchDB revision fields\r\nBy default, the `_rev` element of every document is stripped out of the output of `cdbdump`. This allows the list of documents to be used as input to `cdbload`. If the **-k** parameter is given to `cdbdump`, then the `_rev` elements will *not* be stripped out and this will cause CouchDB to be unable to easily load these documents through the `_bulk_docs` endpoint because every document will error with a mismatched revision message (assuming you are loading into an empty database). See [CouchDB _bulk_docs documentation](http://docs.couchdb.org/en/1.6.1/api/database/bulk-api.html#post--db-_bulk_docs) for more details and ways you can manipulate the `cdbdump` output to get around that in case you need to keep the `_rev` values in your dump.\r\n\r\n#### Default options for cdbdump\r\n\r\n    host = localhost\r\n    port = 5984\r\n    protocol = http\r\n    json-stringify-space = 0\r\n    dont-strip-revs = false\r\n\r\n## `cdbload` Full Usage\r\n\r\nIf you execute the `cdbload` command with no arguments or with --help, the following usage information will be printed on the console and the command will exit.\r\n\r\n`usage: cdbload [-u username] [-p password] [-h host] [-P port] [-r protocol] [-v verbose] -d database`\r\n\r\nThe **-v** parameter for `cdbload` will print CouchDB's response body to the console. That will be an array with one JSON result object for every object loaded in!!\r\n\r\n#### Default options for cdbload\r\n\r\n    host = localhost\r\n    port = 5984\r\n    protocol = http\r\n    verbose = false\r\n\r\n## `cdbmorph` Full Usage\r\n\r\nIf you execute the `cdbmorph` command with no arguments or with --help, the following usage information will be printed on the console and the command will exit.\r\n\r\n`usage: cdbmorph [-s json-stringify-space] -f path-to-morphfunction.js`\r\n\r\nThe **-f** parameter is used to provide the path to the file containing the javascript function that will be applied to every document in the stream. The path can be an absolute path:\r\n\r\n`cat dump.json | cdbmorph -f ~/morph.js`\r\n\r\n... or a relative path to the file from current working directory that the `cdbmorph` command will be run from:\r\n\r\n`cat dump.json | cdbmorph -f ../../../morph.js`\r\n\r\nThe file containing the morph function will be *required* into the script as follows:\r\n\r\n`var morphfunction = require(path.resolve(process.cwd(), path-to-morphfunction.js));`\r\n\r\nThe morph function takes two arguments which are a CouchDB document and a callback.\r\n\r\n#### function(doc, callback)\r\n\r\n###### Arguments\r\n\r\n+ `doc` - A CouchDB document (json).\r\n+ `callback(err, doc)` - A callback function used to return the morphed document or an error. If an error is returned the unchanged document is included in the output stream and the error is printed on error.console. Returning `null` as the *doc* argument causes the original document to be excluded from the output.\r\n\r\n###### Example\r\n\r\n    module.exports = function(doc, cb){\r\n      if(doc.dontmod){\r\n        return cb(null, doc); //unmodified doc is passed through to the output\r\n      }\r\n      if(doc.theexclusionkey){\r\n        return cb(); //doc will not be in the output\r\n      }\r\n      if(doc.somekey && doc.somekey === 'somevalue'){\r\n        doc.anotherkey = 'anothervalue'; //doc is modified in the output\r\n      }\r\n      if(doc.someotherkey && doc.someotherkey === 'someothervalue'){\r\n        doc._deleted = true; //doc is a 'CouchDB deleted document' in the output\r\n      }\r\n      cb(null, doc);\r\n    }\r\n\r\nThe **-s** parameter for `cdbmorph` is used as the third parameter to JSON.stringify() for the amount of white space to use if you want the output to be pretty-printed.\r\n\r\n#### Batch document modifications on a CouchDB database using `cdbmorph`\r\n\r\nAs shown in the usage examples above, it is possible to pass the documents in a CouchDB database through `cdbmorph` for modification as follows:\r\n\r\n`cdbdump -k -d dbname | cdbmorph -f ./morph.js | cdbload -d dbanme`\r\n\r\nTo make this work you must be sure to apply the **-k** flag on the `cdbdump` command so that the documents in the output will include their **_rev** values. By default those would be stripped out which is only appropriate if you are loading the documents into a database where they don't already exist.\r\n\r\nBe mindful of all the normal rules of CouchDB document updates with respect to **_rev** values, etc when performing this kind of operation.\r\n\r\n#### Default options for cdbmorph\r\n\r\n    json-stringify-space = 0\r\n\r\n## Why Another CouchDB Dump Command?\r\nI originally wrote this because I couldn't find a cli dump tool for CouchDB that allowed me to pipe output directly. Since then I also found these other excellent options which you should definitely check out as well:\r\n\r\n- [danielebailo/couchdb-dump](https://github.com/danielebailo/couchdb-dump)\r\n- [pouchdb-dump-cli](https://www.npmjs.com/package/pouchdb-dump-cli)\r\n- [pouchdb-load](https://www.npmjs.com/package/pouchdb-load)\r\n\r\nWith the addition of the `cdbmorph` command in release 2.2.0, this tool is now more than just a CouchDB dump command. It also provides convenient batch document manipulation features on the command line.\r\n\r\n## Testing\r\n\r\nStill no automated tests in place. :\\\r\n\r\n## Contributing\r\n\r\nFork and PR. Thanks!!\r\n\r\n## Release History\r\n\r\n* 2.2.1 Minor cleanup.\r\n* 2.2.0 Provides the `cdbmorph` command that lets you manipulate the documents in the stream between `cdbdump` and `cdbload` using a function you provide.\r\n* 2.1.0 Includes attachments as part of the dump. (Contributed by https://github.com/iddo)\r\n* 2.0.0 Using latest through2 package instead of through.\r\n* 1.2.0 Support for dumping only docs which belong to a specified CouchDB design doc and view.\r\n* 1.1.0 Added Authentication options\r\n* 1.0.0 Initial release\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}