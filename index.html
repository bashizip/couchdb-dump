<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Couchdb-dump by raffi-minassian</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Couchdb-dump</h1>
        <h2>Tools to dump, modify, and load documents in CouchDB from the command line. (Same basic concept as mysqldump, but much more and for CouchDB)</h2>
        <a href="https://github.com/raffi-minassian/couchdb-dump" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>
<a id="couchdb-dump" class="anchor" href="#couchdb-dump" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>couchdb-dump</h1>

<p>A set of three command line tools that perform the following functions. </p>

<ul>
<li>
<code>cdbdump</code> outputs all documents (including any attachments) in a <a href="http://couchdb.apache.org">CouchDB</a> database</li>
<li>
<code>cdbmorph</code> lets you provide a function that can modify the documents in that output</li>
<li>
<code>cdbload</code> takes that output as input and loads it back into a CouchDB database.</li>
</ul>

<p>Reading and writing the data is done via stdin and stdout, respectively. The output of <code>cdbdump</code> is a JSON document containing a "docs" array element which contains the CouchDB database documents. The <code>cdbmorph</code> command takes the output of <code>cdbdump</code> and allows you to modify the documents in it by passing each of them through a function that you supply. The <code>cdbload</code> command takes an input which is exactly the same as the output of <code>cdbdump</code> or <code>cdbmorph</code> and writes every document in it into the target database.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<p><code>npm install -g couchdb-dump</code></p>

<h2>
<a id="usage-examples" class="anchor" href="#usage-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage Examples</h2>

<p>The following will dump the contents of a CouchDB database called <em>myhugedatabase</em> running on port 5984 on localhost. The output is written to a file called <em>myhugedatabase.json</em>.</p>

<p><code>cdbdump -d myhugedatabase &gt; myhugedatabase.json</code></p>

<p>If you are doing this for archiving purposes you could do something like this to extract and gzip by piping output ...</p>

<p><code>cdbdump -d myhugedatabase | gzip &gt; myhugedatabase.json.gz</code></p>

<p>Both of the following command examples will load all the documents in the <em>myhugedatabase.json</em> file into a CouchDB database called <em>myhugeduplicate</em>.</p>

<p><code>cdbload -d myhugeduplicate &lt; myhugedatabase.json</code><br>
 <strong>OR</strong><br>
<code>cat myhugedatabase.json | cdbload -d myhugeduplicate</code></p>

<p>You can even do this ...</p>

<p><code>cdbdump -d myhugedatabase | cdbload -d myhugeduplicate</code></p>

<p>... which streams all the docs from one CouchDB database into a second one. While this works well, you should probably take a look at using <a href="http://guide.couchdb.org/draft/replication.html">CouchDB's awesome built-in replication features</a> instead.</p>

<p>But suppose you need to manipulate the documents in the <code>cdbdump</code> output before you load them into CouchDB with <code>cdbload</code>. You can do that with the included <code>cdbmorph</code> command.</p>

<p>Lets assume you need to add a new key and value to all documents which meet certain criteria, and you need to delete documents which meet some other criteria. So you write a function as follows and save it in a file called <em>morph.js</em>. For example:</p>

<pre><code>module.exports = function(doc, cb){
  if(doc.somekey &amp;&amp; doc.somekey === 'somevalue'){
    doc.anotherkey = 'anothervalue';
  }
  if(doc.someotherkey &amp;&amp; doc.someotherkey === 'someothervalue'){
    doc._deleted = true;
  }
  cb(null, doc);
}
</code></pre>

<p>Now you can run the documents in the <em>myhugedatabase.json</em> file from the example above through this function and feed the output into a file or directly back into a CouchDB database as follows ...</p>

<p><code>cat myhugedatabase.json | cdbmorph -f ./morph.js | cdbload -d myhugemodified</code></p>

<p>You can also pipe output directly from <code>cdbdump</code> to <code>cdbmorph</code> to <code>cdbload</code> like this ...</p>

<p><code>cdbdump -d myhugedatabase | cdbmorph -f ./morph.js | cdbload -d myhugemodified</code></p>

<p>You can even put modified documents back into a CouchDB database by loading the stream of changed documents back into the source database, simulating the feel of in-place-updates, like this ...</p>

<p><code>cdbdump -k -d myhugedatabase | cdbmorph -f ./morph.js | cdbload -d myhugedatabase</code></p>

<p><em>NOTE: This is not magic and it is not "real" in-place-updates so all the rules of CouchDB document updates with respect to</em> <strong>_rev</strong> <em>values, etc, still apply. Be mindful of this and other activity on the database if you do something like this. Also, be sure to apply the</em> <strong>-k</strong> <em>flag on the <code>cdbdump</code> command so that the documents in the output will include their</em> <strong>_rev</strong> <em>values.</em></p>

<h2>
<a id="cdbdump-full-usage" class="anchor" href="#cdbdump-full-usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>cdbdump</code> Full Usage</h2>

<p>If you execute the <code>cdbdump</code> command with no arguments or with --help, the following usage information will be printed on the console and the command will exit.</p>

<p><code>usage: cdbdump [-u username] [-p password] [-h host] [-P port] [-r protocol] [-s json-stringify-space] [-k dont-strip-revs] [-D design doc] [-v view] -d database</code></p>

<p>The username and password, if supplied, will be used for authentication via <a href="http://docs.couchdb.org/en/1.6.1/api/server/authn.html#api-auth-basic">Basic Auth (RFC2617)</a>. Currently this is the only supported authentication method.</p>

<p>If you want to constrain the documents exported to only those that belong to a <a href="http://docs.couchdb.org/en/1.6.1/couchapp/ddocs.html">CouchDB View</a>, you can pass the <strong>-D</strong> and <strong>-v</strong> options to specify the design document and view function name respectively. This won't work with views that <em>reduce</em> or do other fancy things.</p>

<p>The <strong>-s</strong> parameter for <code>cdbdump</code> is used as the third parameter to JSON.stringify() for the amount of white space to use if you want the output to be pretty-printed.</p>

<h5>
<a id="couchdb-revision-fields" class="anchor" href="#couchdb-revision-fields" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>CouchDB revision fields</h5>

<p>By default, the <code>_rev</code> element of every document is stripped out of the output of <code>cdbdump</code>. This allows the list of documents to be used as input to <code>cdbload</code>. If the <strong>-k</strong> parameter is given to <code>cdbdump</code>, then the <code>_rev</code> elements will <em>not</em> be stripped out and this will cause CouchDB to be unable to easily load these documents through the <code>_bulk_docs</code> endpoint because every document will error with a mismatched revision message (assuming you are loading into an empty database). See <a href="http://docs.couchdb.org/en/1.6.1/api/database/bulk-api.html#post--db-_bulk_docs">CouchDB _bulk_docs documentation</a> for more details and ways you can manipulate the <code>cdbdump</code> output to get around that in case you need to keep the <code>_rev</code> values in your dump.</p>

<h4>
<a id="default-options-for-cdbdump" class="anchor" href="#default-options-for-cdbdump" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default options for cdbdump</h4>

<pre><code>host = localhost
port = 5984
protocol = http
json-stringify-space = 0
dont-strip-revs = false
</code></pre>

<h2>
<a id="cdbload-full-usage" class="anchor" href="#cdbload-full-usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>cdbload</code> Full Usage</h2>

<p>If you execute the <code>cdbload</code> command with no arguments or with --help, the following usage information will be printed on the console and the command will exit.</p>

<p><code>usage: cdbload [-u username] [-p password] [-h host] [-P port] [-r protocol] [-v verbose] -d database</code></p>

<p>The <strong>-v</strong> parameter for <code>cdbload</code> will print CouchDB's response body to the console. That will be an array with one JSON result object for every object loaded in!!</p>

<h4>
<a id="default-options-for-cdbload" class="anchor" href="#default-options-for-cdbload" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default options for cdbload</h4>

<pre><code>host = localhost
port = 5984
protocol = http
verbose = false
</code></pre>

<h2>
<a id="cdbmorph-full-usage" class="anchor" href="#cdbmorph-full-usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>cdbmorph</code> Full Usage</h2>

<p>If you execute the <code>cdbmorph</code> command with no arguments or with --help, the following usage information will be printed on the console and the command will exit.</p>

<p><code>usage: cdbmorph [-s json-stringify-space] -f path-to-morphfunction.js</code></p>

<p>The <strong>-f</strong> parameter is used to provide the path to the file containing the javascript function that will be applied to every document in the stream. The path can be an absolute path:</p>

<p><code>cat dump.json | cdbmorph -f ~/morph.js</code></p>

<p>... or a relative path to the file from current working directory that the <code>cdbmorph</code> command will be run from:</p>

<p><code>cat dump.json | cdbmorph -f ../../../morph.js</code></p>

<p>The file containing the morph function will be <em>required</em> into the script as follows:</p>

<p><code>var morphfunction = require(path.resolve(process.cwd(), path-to-morphfunction.js));</code></p>

<p>The morph function takes two arguments which are a CouchDB document and a callback.</p>

<h4>
<a id="functiondoc-callback" class="anchor" href="#functiondoc-callback" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>function(doc, callback)</h4>

<h6>
<a id="arguments" class="anchor" href="#arguments" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Arguments</h6>

<ul>
<li>
<code>doc</code> - A CouchDB document (json).</li>
<li>
<code>callback(err, doc)</code> - A callback function used to return the morphed document or an error. If an error is returned the unchanged document is included in the output stream and the error is printed on error.console. Returning <code>null</code> as the <em>doc</em> argument causes the original document to be excluded from the output.</li>
</ul>

<h6>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example</h6>

<pre><code>module.exports = function(doc, cb){
  if(doc.dontmod){
    return cb(null, doc); //unmodified doc is passed through to the output
  }
  if(doc.theexclusionkey){
    return cb(); //doc will not be in the output
  }
  if(doc.somekey &amp;&amp; doc.somekey === 'somevalue'){
    doc.anotherkey = 'anothervalue'; //doc is modified in the output
  }
  if(doc.someotherkey &amp;&amp; doc.someotherkey === 'someothervalue'){
    doc._deleted = true; //doc is a 'CouchDB deleted document' in the output
  }
  cb(null, doc);
}
</code></pre>

<p>The <strong>-s</strong> parameter for <code>cdbmorph</code> is used as the third parameter to JSON.stringify() for the amount of white space to use if you want the output to be pretty-printed.</p>

<h4>
<a id="batch-document-modifications-on-a-couchdb-database-using-cdbmorph" class="anchor" href="#batch-document-modifications-on-a-couchdb-database-using-cdbmorph" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Batch document modifications on a CouchDB database using <code>cdbmorph</code>
</h4>

<p>As shown in the usage examples above, it is possible to pass the documents in a CouchDB database through <code>cdbmorph</code> for modification as follows:</p>

<p><code>cdbdump -k -d dbname | cdbmorph -f ./morph.js | cdbload -d dbanme</code></p>

<p>To make this work you must be sure to apply the <strong>-k</strong> flag on the <code>cdbdump</code> command so that the documents in the output will include their <strong>_rev</strong> values. By default those would be stripped out which is only appropriate if you are loading the documents into a database where they don't already exist.</p>

<p>Be mindful of all the normal rules of CouchDB document updates with respect to <strong>_rev</strong> values, etc when performing this kind of operation.</p>

<h4>
<a id="default-options-for-cdbmorph" class="anchor" href="#default-options-for-cdbmorph" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Default options for cdbmorph</h4>

<pre><code>json-stringify-space = 0
</code></pre>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/raffi-minassian/couchdb-dump/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/raffi-minassian/couchdb-dump/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/raffi-minassian/couchdb-dump"></a> is maintained by <a href="https://github.com/raffi-minassian">raffi-minassian</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
